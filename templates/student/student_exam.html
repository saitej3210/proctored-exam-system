<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Student Exam</title>

<style>
body{
  margin:0;
  font-family:Segoe UI;
  background:#0f172a;
  color:#e5e7eb;
}
.top{
  position:fixed;
  top:0;left:0;right:0;
  height:60px;
  background:#020617;
  display:flex;
  align-items:center;
  padding:0 16px;
  z-index:10;
}
.container{
  margin-top:70px;
  padding:16px;
}
.card{
  background:#020617;
  border:1px solid #1e293b;
  border-radius:14px;
  padding:16px;
}
label{
  display:block;
  padding:12px;
  margin:10px 0;
  border:1px solid #1e293b;
  border-radius:10px;
  cursor:pointer;
}
input[type=radio]{ margin-right:10px; }

.actions{
  display:flex;
  gap:10px;
  margin-top:15px;
}
button{
  flex:1;
  padding:12px;
  border:none;
  border-radius:10px;
  font-weight:600;
  cursor:pointer;
}
.save{ background:#22c55e; }
.review{ background:#facc15; color:#000; }

.qnav{
  display:flex;
  flex-wrap:wrap;
  gap:8px;
  margin-top:20px;
}
.qbtn{
  width:40px;height:40px;
  border-radius:8px;
  border:none;
  font-weight:600;
}
.notvisited{ background:#334155; color:#fff; }
.answered{ background:#22c55e; color:#000; }
.reviewed{ background:#facc15; color:#000; }
.active{ outline:3px solid #60a5fa; }
</style>
</head>

<body>

<!-- ===============================
     VIOLATION WARNING MODAL
     =============================== -->
<div id="violationModal"
     style="display:none; position:fixed; inset:0;
            background:rgba(0,0,0,0.6);
            z-index:9999;">
  <div style="
      max-width:420px;
      margin:15% auto;
      background:#111827;
      color:#e5e7eb;
      padding:24px;
      border-radius:14px;
      text-align:center;
  ">
    <h2 id="vmTitle">Warning</h2>
    <p id="vmMessage"></p>
    <button onclick="closeViolationModal()">OK</button>
  </div>
</div>

<div class="top">
  <b>Student Exam</b>
</div>

<!-- ‚è≥ EXAM TIMER -->
<div id="examTimerBox"
     style="
       position: fixed;
       top: 12px;
       right: 20px;
       background: #020617;
       border: 2px solid #22c55e;
       color: #22c55e;
       padding: 8px 14px;
       border-radius: 10px;
       font-weight: 700;
       z-index: 9999;
       display: none;
     ">
  ‚è≥ <span id="examTimer">--:--</span>
</div>

<div class="container">

  <div id="questionBox" class="card"></div>

  <div class="actions">
    <button type="button" class="save" onclick="saveNext()">Save & Next</button>
    <button type="button" class="review" onclick="markReview()">Mark for Review</button>
  </div>

  <div id="qnav" class="qnav"></div>

  <form method="POST"
        action="/student/submit_exam"
        style="margin-top:25px;"
        onsubmit="return confirmSubmit();">

    <input type="hidden" name="exam_id" value="{{ exam_id }}">

    <button type="submit"
      style="
        width:100%;
        padding:14px;
        background:#ef4444;
        color:white;
        border:none;
        border-radius:12px;
        font-weight:700;
        font-size:16px;">
      üìù Submit Exam
    </button>
  </form>

</div>

<script>
function confirmSubmit(){
  return confirm("Are you sure you want to submit the exam?");
}
console.log("‚úÖ STUDENT EXAM PAGE JS LOADED");
</script>



</body>
</html>

<script>

/* ================= DATA ================= */
const QUESTIONS = {{ questions | tojson }};
const ANSWERS  = {{ saved_answers | tojson }};
const REVIEW   = {};
const EXAM_ID  = {{ exam_id }};
let index = 0;
let questionStartTime = Date.now(); // ‚è± START TIMER
/* ================= RENDER ================= */
function render(){
  
  const q = QUESTIONS[index];
  const qKey = String(q.question_no);
  
  let html = `<b>Q${q.question_no}. ${q.question}</b><br><br>`;

  ['a','b','c','d'].forEach(opt=>{
    const checked = ANSWERS[qKey] === opt ? 'checked' : '';
    html += `
      <label>
        <input type="radio" name="ans" value="${opt}" ${checked}
          onchange="selectAnswer('${qKey}','${opt}')">
        ${q['option_' + opt]}
      </label>
    `;
  });

  document.getElementById("questionBox").innerHTML = html;
  updateNav();

  questionStartTime = Date.now(); // ‚è± RESET TIMER
}

/* ================= SAVE ANSWER ================= */
function selectAnswer(qKey, opt){
  ANSWERS[qKey] = opt;
  delete REVIEW[qKey];

  const timeTaken = Math.floor((Date.now() - questionStartTime) / 1000);

  console.log("Saving:", EXAM_ID, QUESTIONS[index].question_no, opt, timeTaken);

  fetch("/student/save-answer", {
    method: "POST",
    headers: {
      "Content-Type": "application/json"
    },
    body: JSON.stringify({
      exam_id: EXAM_ID,
      question_no: QUESTIONS[index].question_no,
      selected_option: opt,
      time_taken: timeTaken   // ‚úÖ THIS LINE IS IMPORTANT
    })
  })
  .then(res => res.json())
  .then(d => console.log("Saved:", d))
  .catch(err => console.error("Save error", err));
}
/* ================= ACTIONS ================= */
function saveNext(){
  // üî• SAVE TIME EVEN IF NOT ANSWERED
  const timeTaken = Math.floor((Date.now() - questionStartTime) / 1000);

  fetch("/student/save-answer", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      exam_id: EXAM_ID,
      question_no: QUESTIONS[index].question_no,
      selected_option: ANSWERS[String(QUESTIONS[index].question_no)] || null,
      time_taken: timeTaken
    })
  });

  if(index < QUESTIONS.length - 1){
    index++;
    render();
  }
}
</script>
<script>
function markReview(){
  const qKey = String(QUESTIONS[index].question_no);
  REVIEW[qKey] = true;
  saveNext();
}
</script>
<script>
/* ================= NAV ================= */
function updateNav(){
  const nav = document.getElementById("qnav");
  nav.innerHTML = "";

  QUESTIONS.forEach((q,i)=>{
    const qKey = String(q.question_no);
    let cls = "notvisited";

    if(ANSWERS[qKey]) cls = "answered";
    if(REVIEW[qKey]) cls = "reviewed";
    if(i === index) cls += " active";

    nav.innerHTML += `
      <button type="button" class="qbtn ${cls}" onclick="jump(${i})">
        ${q.question_no}
      </button>
    `;
  });
}

function jump(i){
  index = i;
  render();
}

/* ================= SUBMIT CONFIRM ================= */
function confirmSubmit(){
  return confirm("Are you sure you want to submit the exam?");
}

/* ================= TIMER LOGIC ================= */


</script>
<script>
/* ================= INIT ================= */
render();
</script>
<script>
let lastViolationTime = {};

// MODAL OPEN
function showViolationModal(title, message) {
  document.getElementById("vmTitle").innerText = title;
  document.getElementById("vmMessage").innerText = message;
  document.getElementById("violationModal").style.display = "block";
}

// MODAL CLOSE
function closeViolationModal() {
  document.getElementById("violationModal").style.display = "none";
}

// SEND VIOLATION
function logViolation(type) {
  console.log("üî• VIOLATION FIRED:", type);

  const now = Date.now();
  if (lastViolationTime[type] && now - lastViolationTime[type] < 5000) return;
  lastViolationTime[type] = now;

  fetch("/student/log-violation", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      exam_id: {{ exam_id }},
      student_id: {{ session['student_id'] }},
      event_type: type
    })
  })
  .then(res => res.json())
  .then(data => {
    const count = data.count || data.violation_count || 0;

    // WARNINGS (2‚Äì5)
    if (count >= 2 && count <= 5) {
      showViolationModal(
        "‚ö†Ô∏è Warning",
        "Violation count: " + count +
        "\n\nFurther violations may lead to exam suspension."
      );
    }

    // AUTO PAUSE (6+)
    if (count >= 6) {
      showViolationModal(
        "‚õî Exam Paused",
        "Your exam has been automatically paused due to repeated violations.\n\nPlease wait for administrator approval."
      );

      setTimeout(() => {
        window.location.href = "/exam-paused";
      }, 2000);
    }
  });
}

/* ================= EVENTS ================= */

// TAB SWITCH
document.addEventListener("visibilitychange", () => {
  if (document.hidden) logViolation("tab_switch");
});

// WINDOW BLUR
window.addEventListener("blur", () => {
  logViolation("blur");
});

// MOUSE LEAVE WINDOW
window.addEventListener("mouseleave", () => {
  logViolation("tab_switch");
});

// BACK / REFRESH / CLOSE (SAFE)
window.addEventListener("beforeunload", () => {
  navigator.sendBeacon(
    "/student/log-violation",
    JSON.stringify({
      exam_id: {{ exam_id }},
      student_id: {{ session['student_id'] }},
      event_type: "tab_switch"
    })
  );
});

// COPY / PASTE
document.addEventListener("copy", () => logViolation("copy"));
document.addEventListener("paste", () => logViolation("paste"));
document.addEventListener("cut", () => logViolation("copy"));
</script>
<script>
fetch("/student/init-exam-session", { method: "POST" });
</script>
<script>
document.addEventListener("DOMContentLoaded", async function () {
  const res = await fetch(`/student/exam-timer?exam_id=${EXAM_ID}`);
  const data = await res.json();

  if (!data.enabled) return;

  const box = document.getElementById("examTimerBox");
  const text = document.getElementById("examTimer");

  box.style.display = "block";

  let remaining = data.remaining_seconds;

  const interval = setInterval(() => {
    remaining--;
    text.innerText = remaining;
    if (remaining <= 0) {
      clearInterval(interval);
      document.querySelector('form[action="/student/submit_exam"]').submit();
    }
  }, 1000);
});
</script>
<script>
/* ================= FINAL TIMER BOOTSTRAP ================= */
window.addEventListener("load", async () => {

  console.log("üöÄ FINAL TIMER BOOTSTRAP STARTED");

  if (typeof EXAM_ID === "undefined") {
    console.error("‚ùå EXAM_ID NOT FOUND");
    return;
  }

  try {
    const res = await fetch(`/student/exam-timer?exam_id=${EXAM_ID}`);
    const data = await res.json();

    console.log("‚è≥ FINAL TIMER DATA:", data);

    if (!data.enabled) return;

    const box = document.getElementById("examTimerBox");
    const text = document.getElementById("examTimer");

    if (!box || !text) {
      console.error("‚ùå TIMER DOM MISSING");
      return;
    }

    box.style.display = "block";

    let remaining = data.remaining_seconds;

    const fmt = s =>
      String(Math.floor(s / 60)).padStart(2, "0") + ":" +
      String(s % 60).padStart(2, "0");

    text.innerText = fmt(remaining);

    const interval = setInterval(() => {
      remaining--;
      text.innerText = fmt(remaining);

      if (remaining <= 0) {
        clearInterval(interval);
        alert("‚è∞ Time up! Auto submitting exam.");
        document.querySelector('form[action="/student/submit_exam"]').submit();
      }
    }, 1000);

  } catch (e) {
    console.error("üî• TIMER ERROR:", e);
  }
});
</script>