<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Student Examination</title>

<style>
:root{
  --bg:#0f172a;
  --card:#020617;
  --border:#1e293b;
  --accent:#2563eb;
  --danger:#ef4444;
}
*{box-sizing:border-box}
body{
  margin:0;
  background:var(--bg);
  font-family:"Segoe UI",system-ui,sans-serif;
  color:#e5e7eb;
}

/* ===== TOP BAR ===== */
.top-bar{
  position:fixed;
  top:0;left:0;right:0;
  height:64px;
  background:var(--card);
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:0 28px;
  border-bottom:1px solid var(--border);
  z-index:100;
}

/* TIMER */
#exam-timer{
  font-weight:700;
  color:#f87171;
}

.container{
  max-width:900px;
  margin:100px auto 120px;
  padding:0 20px;
}

/* ===== QUESTIONS ===== */
.question-card{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:16px;
  padding:22px;
  margin-bottom:22px;
}
.question{
  font-size:16px;
  font-weight:600;
  margin-bottom:16px;
}
.q-no{
  background:var(--accent);
  color:white;
  padding:4px 10px;
  border-radius:999px;
  font-size:12px;
  margin-right:8px;
}
.options label{
  display:flex;
  gap:12px;
  padding:12px;
  border-radius:10px;
  border:1px solid var(--border);
  margin-bottom:10px;
  cursor:pointer;
}
.options label:hover{border-color:var(--accent)}

/* ===== SUBMIT BAR ===== */
.submit-bar{
  position:fixed;
  bottom:0;left:0;right:0;
  padding:18px;
  background:linear-gradient(180deg,transparent,var(--bg));
}
.submit-box{
  max-width:900px;
  margin:auto;
  display:flex;
  justify-content:flex-end;
}
.submit-btn{
  padding:14px 32px;
  border-radius:12px;
  border:none;
  background:linear-gradient(135deg,#22c55e,#16a34a);
  font-weight:700;
  cursor:pointer;
}

/* ===== PAUSE OVERLAY ===== */
#pauseOverlay{
  display:none;
  position:fixed;
  inset:0;
  background:#020617;
  z-index:9999;
  align-items:center;
  justify-content:center;
  text-align:center;
}
</style>
</head>

<body>

<div class="top-bar">
  <h1>Student Examination</h1>
</div>

<div class="container">
<form method="POST" id="examForm">
{% for q in questions %}
  <div class="question-card">
    <div class="question">
      <span class="q-no">Q{{ loop.index }}</span>{{ q.question }}
    </div>
    <div class="options">
      <label><input type="radio" name="q_{{ q.id }}" value="a"> {{ q.option_a }}</label>
      <label><input type="radio" name="q_{{ q.id }}" value="b"> {{ q.option_b }}</label>
      <label><input type="radio" name="q_{{ q.id }}" value="c"> {{ q.option_c }}</label>
      <label><input type="radio" name="q_{{ q.id }}" value="d"> {{ q.option_d }}</label>
    </div>
  </div>
{% endfor %}
</form>
</div>

<div class="submit-bar">
  <div class="submit-box">
    <button type="submit" form="examForm" class="submit-btn">
      Submit Examination
    </button>
  </div>
</div>

<!-- ===== PAUSE OVERLAY ===== -->
<div id="pauseOverlay">
  <div>
    <h2>⏸ Exam Paused</h2>
    <p>Rule violation detected</p>
    <p>Waiting for admin approval</p>
  </div>
</div>

<script>
const STUDENT_ID = {{ student_id }};
const EXAM_ID = {{ exam_id }};

let hardPaused = false;
let IS_REFRESH = false;

/* ✅ MARK REFRESH */
window.addEventListener("beforeunload", () => {
  IS_REFRESH = true;
});

/* ---------- PAUSE ---------- */
function pauseExam(){
  if(hardPaused) return;

  hardPaused = true;

  fetch("/exam/pause",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({ student_id:STUDENT_ID, exam_id:EXAM_ID })
  });

  document.getElementById("pauseOverlay").style.display="flex";
}

/* ---------- TAB / WINDOW DETECTION ---------- */
document.addEventListener("visibilitychange",()=>{
  if(document.hidden && !IS_REFRESH){
    pauseExam();
  }
});

window.addEventListener("blur",()=>{
  if(!IS_REFRESH){
    pauseExam();
  }
});

/* ---------- BLOCK BACK ---------- */
history.pushState(null,"",location.href);
window.onpopstate=()=>history.pushState(null,"",location.href);

/* ---------- STATUS POLLING ---------- */
setInterval(async()=>{
  const r = await fetch(`/exam/status/${EXAM_ID}`);
  const d = await r.json();

  if(hardPaused && d.status==="RUNNING"){
    hardPaused = false;
    document.getElementById("pauseOverlay").style.display="none";
    location.reload();
  }

  if(d.status==="REMOVED") location.replace("/student/login");
  if(d.status==="SUBMITTED") location.replace("/student/result");
},3000);
</script>

<!-- ===== ANSWER PERSISTENCE ===== -->
<script>
const STORAGE_KEY = "exam_answers_{{ exam_id }}_{{ student_id }}";

document.querySelectorAll("input[type=radio]").forEach(radio=>{
  radio.addEventListener("change",()=>{
    let saved=JSON.parse(localStorage.getItem(STORAGE_KEY)||"{}");
    saved[radio.name]=radio.value;
    localStorage.setItem(STORAGE_KEY,JSON.stringify(saved));
  });
});

window.addEventListener("load",()=>{
  const saved=JSON.parse(localStorage.getItem(STORAGE_KEY)||"{}");
  Object.entries(saved).forEach(([n,v])=>{
    const i=document.querySelector(`input[name="${n}"][value="${v}"]`);
    if(i) i.checked=true;
  });
});

document.getElementById("examForm").addEventListener("submit",()=>{
  localStorage.removeItem(STORAGE_KEY);
});
</script>

<!-- ===== TIMER (SERVER SOURCE ONLY) ===== -->
<script>
const TIMER_EL = document.createElement("div");
TIMER_EL.style.cssText =
  "position:fixed;top:14px;right:28px;font-weight:700;color:#f87171";
document.querySelector(".top-bar").appendChild(TIMER_EL);

setInterval(async () => {
  const r = await fetch(`/exam/timer/${EXAM_ID}`);
  const d = await r.json();

  if (!d.enabled) {
    TIMER_EL.innerText = "";
    return;
  }

  const sec = d.remaining_seconds;
  const m = Math.floor(sec / 60);
  const s = sec % 60;

  TIMER_EL.innerText = `⏱ Time Left: ${m}:${s.toString().padStart(2, "0")}`;

  if (sec <= 0) {
    document.getElementById("examForm").submit();
  }
}, 1000);
</script>

</body>
</html>